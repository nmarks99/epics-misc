# In this example, the asynPortDriver has a RUN_PROCESS parameter, which
# can be written to via the xxx:StartProcess record. When the xxx:StartProcess
# record processes, an aynchronous process starts on the device. In a real
# scenario, this could be moving a motor to a target position, however in
# this example it simply counts to 5 seconds to simulate some process that
# takes real time to complete. There is also another PV, xxx:Done which is 1
# when the asynchronous process is done, and 0 when the process is running.
#
# In this example, we want to run this process several times, however we must
# wait for the previous process to finish before starting the next one.
# TODO: HOW???


record(calcout, "$(P)ProcessStarted") {
    field(INPA, "$(P)Done.RVAL CP")
    field(OOPT, "Transition To Zero")
    field(CALC, "!A")
}

record(longout, "$(P)Index") {
    field(DESC, "Index of process in chain")
    field(VAL, 0)
}


# Process 1
record(longout, "$(P)Go1") {
    field(VAL, 1)
    field(OUT, "$(P)StartProcess CA")
    field(FLNK, "$(P)set_index_1.PROC")
}
record(bo, "$(P)set_index_1") {
    field(VAL, 1)
    field(OUT, "$(P)Index")
}
record(calcout, "$(P)ProcessFinished1") {
    field(INPA, "$(P)Done.RVAL")
    field(INPB, "$(P)Index.VAL PP")
    field(INPC, "$(P)ProcessStarted.VAL CP")
    field(OOPT, "Transition To Non-zero")
    field(CALC, "((A==1) && (B==1)) ? 1 : 0")
    field(OUT, "$(P)Go2.PROC")
}


# Process 2
record(longout, "$(P)Go2") {
    field(VAL, 2)
    field(OUT, "$(P)StartProcess CA")
    field(FLNK,"$(P)set_index_2.PROC")
}
record(bo, "$(P)set_index_2") {
    field(VAL, 2)
    field(OUT, "$(P)Index")
}
record(calcout, "$(P)ProcessFinished2") {
    field(INPA, "$(P)Done.RVAL")
    field(INPB, "$(P)Index.VAL PP")
    field(INPC, "$(P)ProcessStarted.VAL CP")
    field(OOPT, "Transition To Non-zero")
    field(CALC, "((A==1) && (B==2)) ? 1 : 0")
    field(OUT, "$(P)Go3.PROC")
}


# Process 3
record(longout, "$(P)Go3") {
    field(VAL, 3)
    field(OUT, "$(P)StartProcess CA")
    field(FLNK, "$(P)set_index_3.PROC")
}
record(bo, "$(P)set_index_3") {
    field(VAL, 3)
    field(OUT, "$(P)Index")
}
# record(calcout, "$(P)ProcessFinished3") {
    # field(INPA, "$(P)Done.RVAL")
    # field(INPB, "$(P)Index.VAL PP")
    # field(INPC, "$(P)ProcessStarted.VAL CP")
    # field(OOPT, "Transition To Non-zero")
    # field(CALC, "((A==1) && (B==3)) ? 2 : 0")
# }
